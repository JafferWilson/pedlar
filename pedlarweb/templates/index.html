{% extends "main_base.html" %}
{% block columns %}
<div id="app"> <!-- Vue Wrapper for dynamic content -->
  {% raw %}
  <!-- Middle Column -->
  <div class="w3-col m7">
    <div class="w3-row-padding">
      <div class="w3-card w3-white">
        <table class="w3-table w3-striped">
          <tr class="w3-theme-l3">
            <th>Name</th>
            <th>Balance</th>
          </tr>
          <tr v-for="l in leaders">
            <td>{{ l.username }}</td>
            <td>{{ l.balance }}</td>
          </tr>
        </table>
      </div>
      <br>
      <div class="w3-card w3-white">
        <table class="w3-table w3-striped">
          <tr class="w3-theme-d3">
            <th>Agent</th>
            <th>Type</th>
            <th>Price Open</th>
            <th>Price Close</th>
            <th>Profit</th>
            <th>Created</th>
            <th>Closed</th>
          </tr>
          <tr v-for="o in orders">
            <td>{{ o.agent }}</td>
            <td>{{ o.type }}</td>
            <td>{{ o.price_open }}</td>
            <td>{{ o.price_close }}</td>
            <td>{{ o.profit }}</td>
            <td>{{ o.created.toLocaleString() }}</td>
            <td>{{ o.closed.toLocaleString() }}</td>
          </tr>
        </table>
      </div>
      <br>
    </div>
  </div> <!-- End Middle Column -->

  <!-- Right Column -->
  <div class="w3-col m3">
    <div class="w3-card w3-white">
      <div class="w3-container">
        <div id="chatbox" class="w3-panel w3-border" style="min-height:60vh;max-height:60vh;overflow-y:scroll">
          <p v-for="m in messages" style="white-space:pre-wrap"><b>{{ m.username }}:</b> {{ m.msg }}</p>
        </div>
        <textarea id="chatinput" v-on:keypress.enter.exact.prevent="sendchat" class="w3-input w3-margin-bottom" style="max-width:100%" placeholder="message"></textarea>
      </div>
    </div>
    <br>
  </div> <!-- End Right Column -->
  {% endraw %}
</div> <!-- End Vue Wrapper -->
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
{% if config['DEBUG'] %}
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
{% else %}
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
{% endif %}
<script>
// Setup socket connection
var socket = io.connect('http://' + document.domain + ':' + location.port);
socket.on('connect', function() {
  console.log("Socket connected.")
});
// Setup Vue dynamic components
var app = new Vue({
  el: '#app',
  data: {
    leaders: [],
    orders: [], // Vue is unhappy with dict changes so use array
    messages: []
  },
  // Event handlers
  methods: {
    sendchat: function(event) {
      if (/\S/.test(event.target.value)) {
        payload = {username: '{{ current_user.username }}',
                   msg: event.target.value};
        socket.emit('chat', payload);
        event.target.value = "";
      }
    },
    addmessage: function(msg) {
      this.messages.push(msg);
      var container = this.$el.querySelector("#chatbox");
      container.scrollTop = container.scrollHeight;
    }
  }
});
// Handle incoming socket messages
socket.on('chat', app.addmessage);
socket.on('leaderboard', function(leaders) {
  app.leaders = leaders;
});

function cleanOrder(order) {
  if (order.closed) {
    order.closed = new Date(order.closed);
  } else {
    order.closed = { toLocaleString: () => "" }
  }
  order.created = new Date(order.created);
}

socket.on('orders', function(orders) {
  for(i in orders) {
    cleanOrder(orders[i]);
  }
  app.orders = orders;
});
socket.on('order', function(order) {
  cleanOrder(order);
  // Check for updating order
  idx = app.orders.findIndex((x) => { return x.id == order.id; });
  if (idx == -1) {
    app.orders.unshift(order);
  } else {
    Vue.set(app.orders, idx, order);
  }
});
</script>
{% endblock %}
